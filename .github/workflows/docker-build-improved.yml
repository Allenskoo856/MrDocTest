name: Docker Build and Push (Improved)

# ä»…åœ¨æ¨é€åˆ° master åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [ master ]

env:
  IMAGE_NAME: mymrdoc
  REGISTRY: docker.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        version: latest
        driver-opts: network=host

    - name: ğŸ” éªŒè¯ DockerHub å‡­æ®
      id: check-secrets
      run: |
        if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
          echo "âŒ é”™è¯¯: ç¼ºå°‘ DOCKERHUB_USERNAME"
          echo "missing_username=true" >> $GITHUB_OUTPUT
        else
          echo "âœ… DockerHub ç”¨æˆ·åå·²é…ç½®: ${{ secrets.DOCKERHUB_USERNAME }}"
          echo "missing_username=false" >> $GITHUB_OUTPUT
        fi
        
        if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
          echo "âŒ é”™è¯¯: ç¼ºå°‘ DOCKERHUB_TOKEN"
          echo "missing_token=true" >> $GITHUB_OUTPUT
        else
          echo "âœ… DockerHub Token å·²é…ç½®"
          echo "missing_token=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ“ æ˜¾ç¤ºé…ç½®æŒ‡å—
      if: steps.check-secrets.outputs.missing_username == 'true' || steps.check-secrets.outputs.missing_token == 'true'
      run: |
        echo "ğŸš¨ DockerHub è®¤è¯é…ç½®ä¸å®Œæ•´ï¼"
        echo ""
        echo "ğŸ“‹ è¯·åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ ä»¥ä¸‹ Secrets:"
        echo "   ğŸ”— https://github.com/${{ github.repository }}/settings/secrets/actions"
        echo ""
        echo "ğŸ”‘ éœ€è¦æ·»åŠ çš„ Secrets:"
        if [ "${{ steps.check-secrets.outputs.missing_username }}" = "true" ]; then
          echo "   âŒ DOCKERHUB_USERNAME - æ‚¨çš„ DockerHub ç”¨æˆ·å"
        fi
        if [ "${{ steps.check-secrets.outputs.missing_token }}" = "true" ]; then
          echo "   âŒ DOCKERHUB_TOKEN - æ‚¨çš„ DockerHub è®¿é—®ä»¤ç‰Œ"
        fi
        echo ""
        echo "ğŸ¯ è·å– DockerHub Token çš„æ­¥éª¤:"
        echo "   1. ç™»å½• https://hub.docker.com/"
        echo "   2. å³ä¸Šè§’å¤´åƒ â†’ Account Settings"
        echo "   3. Security â†’ New Access Token"
        echo "   4. åˆ›å»ºå…·æœ‰ Read, Write, Delete æƒé™çš„ Token"
        echo "   5. å¤åˆ¶ç”Ÿæˆçš„ Token åˆ° GitHub Secrets"
        exit 1

    - name: ğŸ³ ç™»å½• DockerHub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: ğŸ“¥ ä¸‹è½½ä¸­æ–‡å­—ä½“
      run: |
        echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½ä¸­æ–‡å­—ä½“æ–‡ä»¶..."
        curl -L -o SourceHanSerifCN-Medium.otf "https://github.com/adobe-fonts/source-han-serif/raw/release/OTF/SimplifiedChinese/SourceHanSerifCN-Medium.otf"
        if [ -f "SourceHanSerifCN-Medium.otf" ]; then
          echo "âœ… å­—ä½“æ–‡ä»¶ä¸‹è½½å®Œæˆ ($(du -h SourceHanSerifCN-Medium.otf | cut -f1))"
        else
          echo "âŒ å­—ä½“æ–‡ä»¶ä¸‹è½½å¤±è´¥"
          exit 1
        fi

    - name: ğŸ“Š è·å–æäº¤ä¿¡æ¯
      id: commit
      run: |
        echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "commit_msg=$(git log -1 --pretty=%B | head -1)" >> $GITHUB_OUTPUT
        echo "build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

    - name: ğŸ·ï¸ ç”Ÿæˆé•œåƒæ ‡ç­¾
      id: meta
      run: |
        TAGS=""
        TAGS="$TAGS${{ env.REGISTRY }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
        TAGS="$TAGS,${{ env.REGISTRY }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:master"
        TAGS="$TAGS,${{ env.REGISTRY }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.commit.outputs.sha_short }}"
        echo "tags=$TAGS" >> $GITHUB_OUTPUT
        
        echo "ğŸ·ï¸ å°†è¦æ„å»ºçš„æ ‡ç­¾:"
        echo "$TAGS" | tr ',' '\n' | sed 's/^/  - /'

    - name: ğŸ”¨ æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: |
          org.opencontainers.image.title=MrDoc
          org.opencontainers.image.description=MrDoc åœ¨çº¿æ–‡æ¡£ç³»ç»Ÿ - ç§æœ‰åŒ–éƒ¨ç½²æ–¹æ¡ˆ
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.version=${{ steps.commit.outputs.sha_short }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.created=${{ steps.commit.outputs.build_date }}
          org.opencontainers.image.vendor=MrDoc
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1

    - name: ğŸ‰ æ„å»ºæˆåŠŸé€šçŸ¥
      run: |
        echo "ğŸ‰ Docker é•œåƒæ„å»ºå¹¶æ¨é€æˆåŠŸï¼"
        echo ""
        echo "ğŸ“¦ é•œåƒä¿¡æ¯:"
        echo "${{ steps.meta.outputs.tags }}" | tr ',' '\n' | sed 's/^/  - /'
        echo ""
        echo "ğŸš€ ä½¿ç”¨æ–¹å¼:"
        echo "  # æ‹‰å–æœ€æ–°é•œåƒ"
        echo "  docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
        echo ""
        echo "  # è¿è¡Œå®¹å™¨"
        echo "  docker run -d -p 10086:10086 --name mrdoc ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
        echo ""
        echo "  # ä½¿ç”¨ Docker Compose"
        echo "  # ç¼–è¾‘ deploy/docker-compose.yml ä¸­çš„é•œåƒåç§°ä¸º:"
        echo "  # image: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
        echo ""
        echo "ğŸ“ æœ¬æ¬¡æäº¤: ${{ steps.commit.outputs.commit_msg }}"
        echo "ğŸ• æ„å»ºæ—¶é—´: ${{ steps.commit.outputs.build_date }}"