name: Auto Build on Master

# ä»…åœ¨æ¨é€åˆ° master åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [ master ]

env:
  IMAGE_NAME: mymrdoc

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½• DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: ä¸‹è½½ä¸­æ–‡å­—ä½“
      run: |
        echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½ä¸­æ–‡å­—ä½“æ–‡ä»¶..."
        curl -L -o SourceHanSerifCN-Medium.otf "https://github.com/adobe-fonts/source-han-serif/raw/release/OTF/SimplifiedChinese/SourceHanSerifCN-Medium.otf"
        echo "âœ… å­—ä½“æ–‡ä»¶ä¸‹è½½å®Œæˆ"

    - name: è·å–æäº¤ä¿¡æ¯
      id: commit
      run: |
        echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "commit_msg=$(git log -1 --pretty=%B | head -1)" >> $GITHUB_OUTPUT

    - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:master
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.commit.outputs.sha_short }}
        labels: |
          org.opencontainers.image.title=MrDoc
          org.opencontainers.image.description=MrDoc åœ¨çº¿æ–‡æ¡£ç³»ç»Ÿ
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: æ„å»ºæˆåŠŸé€šçŸ¥
      run: |
        echo "ğŸ‰ Docker é•œåƒæ„å»ºå¹¶æ¨é€æˆåŠŸï¼"
        echo ""
        echo "ğŸ“¦ é•œåƒä¿¡æ¯:"
        echo "  - ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
        echo "  - ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:master" 
        echo "  - ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.commit.outputs.sha_short }}"
        echo ""
        echo "ğŸš€ ä½¿ç”¨æ–¹å¼:"
        echo "  docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
        echo "  docker run -d -p 10086:10086 --name mrdoc ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
        echo ""
        echo "ğŸ“ æœ¬æ¬¡æäº¤: ${{ steps.commit.outputs.commit_msg }}"