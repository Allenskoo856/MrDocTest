
# 数据模型

<cite>
**本文档引用的文件**  
- [app_doc/models.py](file://app_doc/models.py#L0-L269)
- [app_admin/models.py](file://app_admin/models.py#L0-L66)
- [app_api/models.py](file://app_api/models.py#L0-L25)
</cite>

## 目录
1. [数据模型](#数据模型)
2. [核心数据实体](#核心数据实体)
3. [实体关系图](#实体关系图)
4. [数据验证与业务逻辑](#数据验证与业务逻辑)
5. [数据访问模式](#数据访问模式)
6. [数据库性能考虑](#数据库性能考虑)
7. [数据生命周期管理](#数据生命周期管理)

## 核心数据实体

本文档详细描述 MrDoc 系统中的核心数据模型，包括 `User`（用户）、`Project`（文集）、`Doc`（文档）、`DocHistory`（文档历史）、`Image`（图片）、`Attachment`（附件）等关键实体。

### 用户 (User)

`User` 模型由 Django 的 `django.contrib.auth.models` 提供，是系统的基础身份模型。MrDoc 通过外键关联此模型来实现用户与各类资源的绑定。

### 文集 (Project)

`Project` 模型代表一个文档集合，是组织和管理文档的核心单元。

**字段定义：**
- **name**: `CharField`，文集名称，最大长度 50。
- **icon**: `CharField`，文集图标，可为空。
- **intro**: `TextField`，文集介绍。
- **role**: `IntegerField`，文集权限，取值 0（公开）、1（私密）、2（指定用户可见）、3（访问码可见）。
- **role_value**: `TextField`，权限值，用于存储指定可见用户的列表或访问码。
- **is_watermark**: `BooleanField`，是否启用水印。
- **watermark_type**: `IntegerField`，水印类型，1 为文字水印，2 为图片水印。
- **watermark_value**: `CharField`，水印内容。
- **is_top**: `BooleanField`，是否置顶。
- **create_user**: `ForeignKey`，外键关联 `User`，表示创建者。
- **create_time**: `DateTimeField`，创建时间，自动添加。
- **modify_time**: `DateTimeField`，修改时间，自动更新。

**Section sources**
- [app_doc/models.py](file://app_doc/models.py#L4-L38)

### 文档 (Doc)

`Doc` 模型代表文集中的单个文档，是内容存储的核心。

**字段定义：**
- **name**: `CharField`，文档标题，最大长度 255。
- **pre_content**: `TextField`，编辑内容，用于存储编辑器中的临时内容。
- **content**: `TextField`，文档内容，存储最终的 Markdown 或 HTML 内容。
- **parent_doc**: `IntegerField`，上级文档 ID，用于构建文档树形结构，0 表示根文档。
- **top_doc**: `IntegerField`，所属文集 ID。
- **sort**: `IntegerField`，排序值，用于在文集中对文档进行排序。
- **create_user**: `ForeignKey`，外键关联 `User`，表示创建者。
- **create_time**: `DateTimeField`，创建时间，自动添加。
- **modify_time**: `DateTimeField`，修改时间，自动更新。
- **status**: `IntegerField`，文档状态，0 为草稿，1 为发布，2 为删除（逻辑删除）。
- **editor_mode**: `IntegerField`，编辑器模式，1 为 Editormd，2 为 Vditor，3 为 iceEditor。
- **open_children**: `BooleanField`，是否展开下级目录。
- **show_children**: `BooleanField`，是否在正文中显示下级文档。

**索引：**
- 在 `top_doc`, `parent_doc`, `status` 字段上建立了复合索引，以优化文集内文档的查询效率。
- 在 `sort` 字段上建立了单独索引，以优化排序查询。

**Section sources**
- [app_doc/models.py](file://app_doc/models.py#L70-L109)

### 文档历史 (DocHistory)

`DocHistory` 模型用于实现文档的版本控制。

**字段定义：**
- **doc**: `ForeignKey`，外键关联 `Doc`，表示该历史记录属于哪个文档。
- **pre_content**: `TextField`，文档历史编辑内容，保存每次修改前的内容。
- **create_user**: `ForeignKey`，外键关联 `User`，表示执行修改的用户。当用户被删除时，此字段设为 `NULL`。
- **create_time**: `DateTimeField`，创建时间，自动更新。

**Section sources**
- [app_doc/models.py](file://app_doc/models.py#L111-L121)

### 图片 (Image) 与 附件 (Attachment)

这两个模型用于管理用户上传的媒体文件。

**Image 模型字段：**
- **user**: `ForeignKey`，上传者。
- **file_path**: `CharField`，图片存储路径。
- **file_name**: `CharField`，图片名称。
- **group**: `ForeignKey`，外键关联 `ImageGroup`（图片分组）。
- **remark**: `CharField`，图片备注。
- **create_time**, **modify_time**: 创建和修改时间。

**Attachment 模型字段：**
- **file_name**: `CharField`，附件名。
- **file_size**: `CharField`，附件大小。
- **file_path**: `FileField`，文件存储路径，使用 `upload_to` 指定上传目录。
- **user**: `ForeignKey`，上传者。
- **create_time**: 创建