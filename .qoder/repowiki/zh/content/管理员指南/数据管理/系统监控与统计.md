# 系统监控与统计

<cite>
**本文档引用文件**  
- [views.py](file://app_admin/views.py#L372-L409) - *已更新*
- [admin_overview.html](file://template/app_admin/admin_overview.html#L0-L250) - *已更新*
- [models.py](file://app_doc/models.py#L0-L270)
</cite>

## 更新摘要
**已更新内容**  
- 根据最新代码变更，更新了前端模板 `admin_overview.html` 的界面描述
- 修正了“前端模板结构说明”章节中关于按钮组的过时信息
- 更新了“系统概览”章节以反映最新的UI设计
- 保持了后端逻辑、数据统计和缓存机制等核心内容不变

## 目录
1. [系统概览](#系统概览)  
2. [数据统计实现逻辑](#数据统计实现逻辑)  
3. [实时监控数据获取](#实时监控数据获取)  
4. [统计数据缓存机制](#统计数据缓存机制)  
5. [前端模板结构说明](#前端模板结构说明)  
6. [后端代码实现](#后端代码实现)  
7. [自定义统计图表扩展](#自定义统计图表扩展)  
8. [新增统计指标方法](#新增统计指标方法)

## 系统概览

本系统提供全面的后台监控与统计功能，主要面向管理员用户。通过`admin_overview`视图和`admin_overview.html`模板，系统展示关键运营数据，包括用户总数、文集总数、文档总数、图片与附件数量等核心指标。该功能位于后台管理的仪表盘页面，为系统管理员提供直观的数据概览，帮助其掌握平台整体运行状况。

根据最新的代码变更，管理后台的界面展示已进行优化，移除了文档管理页中的“链接”卡片和导航按钮，并将管理概览页中的按钮组替换为图片展示，提升了界面的视觉效果和用户体验。

## 数据统计实现逻辑

系统通过Django ORM的`count()`聚合函数高效查询各类数据总量，确保统计结果的准确性和查询性能。

### 核心统计指标查询方法

- **用户总数**: `User.objects.all().count()`  
  查询Django内置用户模型`User`的全部记录数量。

- **文集总数**: `Project.objects.all().count()`  
  查询`Project`模型的全部记录数量，代表系统中创建的文集总数。

- **文档总数**: `Doc.objects.all().count()`  
  查询`Doc`模型的全部记录数量，代表系统中创建的文档总数。

- **个人图片总数**: `Image.objects.filter(user=request.user).count()`  
  查询当前登录管理员用户上传的图片数量。

- **个人附件总数**: `Attachment.objects.filter(user=request.user).count()`  
  查询当前登录管理员用户上传的附件数量。

- **文档动态**: `Doc.objects.all().order_by('-modify_time')[:5]`  
  按修改时间倒序排列，获取最近修改的5篇文档，用于展示系统最新动态。

### 性能优化策略

使用`count()`函数是Django ORM推荐的高效计数方式。它直接在数据库层面执行`COUNT(*)` SQL语句，避免了将所有数据加载到内存中再进行计数，极大地提升了查询性能，尤其在数据量庞大的情况下优势明显。

## 实时监控数据获取

当前系统实现的“实时”监控数据主要指在用户访问仪表盘时即时计算并展示的统计数据。其逻辑如下：

1.  当管理员用户发起`GET`请求访问`/admin_overview`页面时，后端视图`admin_overview`被触发。
2.  视图函数立即执行一系列`count()`查询，从数据库中获取最新的数据统计。
3.  这些统计结果作为上下文变量（如`user_cnt`, `pro_cnt`, `doc_cnt`）传递给前端模板。
4.  前端模板将这些变量渲染到对应的HTML元素中，最终呈现给用户。

此方法保证了数据的实时性，但每次页面刷新都会产生数据库查询。对于更高要求的实时监控（如在线用户数），系统当前未实现，但可通过以下方式扩展：

- **当前在线用户数**: 可通过记录用户会话（Session）或使用Redis等内存数据库存储用户最后活跃时间来实现。例如，定义一个“在线”的标准（如5分钟内有活动），然后查询满足此条件的用户会话数量。

## 统计数据缓存机制

为了提高页面加载性能，减少对数据库的频繁查询，可以引入缓存机制。虽然在提供的代码中未直接体现，但根据项目配置，系统支持多种缓存后端。

### 缓存策略建议

1.  **缓存后端**: 系统配置文件`settings.py`中定义了多种缓存后端，包括`redis`、`memcached`、`database`和`locmem`。推荐使用`redis`或`memcached`，因为它们是高性能的内存缓存，非常适合存储频繁读取的统计数据。

2.  **缓存实现**:
    ```python
    from django.core.cache import cache

    # 在admin_overview视图中，先尝试从缓存获取数据
    user_cnt = cache.get('user_count')
    if user_cnt is None:
        user_cnt = User.objects.all().count()
        cache.set('user_count', user_cnt, 60*5) # 缓存5分钟

    pro_cnt = cache.get('project_count')
    if pro_cnt is None:
        pro_cnt = Project.objects.all().count()
        cache.set('project_count', pro_cnt, 60*5)

    # ... 其他统计指标同理
    ```
    此代码逻辑为：首先尝试从缓存中获取数据，如果缓存中不存在（`None`），则执行数据库查询，并将结果存入缓存，设置一个合理的过期时间（如300秒，即5分钟）。这样，在缓存有效期内，后续的页面访问将直接从缓存读取数据，显著降低数据库负载。

## 前端模板结构说明

`admin_overview.html`文件定义了仪表盘页面的前端展示结构，使用Layui框架构建。

### 主要结构与数据绑定

1.  **顶部统计面板**:
    -   使用`layui-col`布局将页面分为多个统计卡片。
    -   每个卡片（`layui-card`）包含一个标题（`layui-card-header`）和内容区域（`layui-card-body`）。
    -   统计数字通过Django模板语法`{{ variable_name }}`动态插入，例如`{{ user_cnt }}`、`{{ pro_cnt }}`、`{{ doc_cnt }}`。
    -   根据最新的UI优化，管理概览页中的按钮组已被替换为图片展示，提升了界面的视觉呈现。

2.  **动态信息展示**:
    -   使用`<dl class="layuiadmin-card-status">`定义一个描述列表来展示文档动态。
    -   通过`{% for doc in doc_active_list %}`循环遍历后端传递的`doc_active_list`列表。
    -   在循环体内，通过`{{doc.create_user.first_name}}`、`{{doc.name}}`、`{{doc.modify_time}}`等语法展示文档的创建者、名称和修改时间。

3.  **快速草稿功能**:
    -   提供一个表单，允许管理员快速创建文档草稿。
    -   文集选择下拉框通过`{% for pro in pro_list %}`循环填充，`pro_list`是后端传递的当前用户创建的文集列表。

**前端模板来源**  
- [admin_overview.html](file://template/app_admin/admin_overview.html#L0-L241) - *已更新*

## 后端代码实现

核心后端逻辑位于`app_admin/views.py`文件的`admin_overview`函数中。

```python
# 后台管理 - 仪表盘
@superuser_only
def admin_overview(request):
    if request.method == 'GET':
        # 用户数
        user_cnt = User.objects.all().count()
        # 文集数
        pro_cnt = Project.objects.all().count() # 文集总数
        # 文档数
        doc_cnt = Doc.objects.all().count() # 文档总数
        total_tag_cnt = Tag.objects.filter(create_user=request.user).count()
        img_cnt = Image.objects.filter(user=request.user).count()
        attachment_cnt = Attachment.objects.filter(user=request.user).count()
        # 文档动态
        doc_active_list = Doc.objects.all().order_by('-modify_time')[:5]
        # 个人文集列表
        pro_list = Project.objects.filter(create_user=request.user).order_by('-create_time')
        return render(request,'app_admin/admin_overview.html',locals())
    else:
        pass
```

**代码解析**:
-   **权限控制**: `@superuser_only`装饰器确保只有超级管理员才能访问此页面。
-   **HTTP方法处理**: 仅处理`GET`请求。
-   **数据查询**: 使用`count()`方法获取各项统计数据。
-   **数据传递**: 使用`locals()`函数将当前作用域内的所有局部变量（`user_cnt`, `pro_cnt`, `doc_cnt`, `img_cnt`, `attachment_cnt`, `doc_active_list`, `pro_list`）作为上下文传递给模板。
-   **页面渲染**: 调用`render`函数，将数据与`admin_overview.html`模板结合，生成最终的HTML响应。

**后端代码来源**  
- [views.py](file://app_admin/views.py#L372-L409) - *已更新*

## 自定义统计图表扩展

系统当前的统计以数字卡片和列表为主。要扩展自定义统计图表（如柱状图、折线图），可以集成前端图表库（如ECharts）。

### 扩展步骤

1.  **引入图表库**: 在`admin_overview.html`的`{% block custom_element %}`中引入ECharts的JS文件。
2.  **准备图表数据**: 在`admin_overview`视图中，查询生成图表所需的数据。例如，统计每日新增用户数：
    ```python
    # 获取过去7天每天的新增用户数
    today = datetime.date.today()
    date_list = [today - datetime.timedelta(days=i) for i in range(6, -1, -1)]
    user_count_data = []
    for date in date_list:
        next_date = date + datetime.timedelta(days=1)
        count = User.objects.filter(date_joined__gte=date, date_joined__lt=next_date).count()
        user_count_data.append(count)
    ```
3.  **传递数据**: 将`date_list`和`user_count_data`作为上下文变量传递给模板。
4.  **前端渲染**: 在`{% block custom_script %}`中编写JavaScript代码，初始化ECharts实例，并使用传递的数据配置图表。

## 新增统计指标方法

向系统添加新的统计指标非常简单，遵循“后端查询 -> 传递数据 -> 前端展示”的模式。

### 添加新指标示例：统计被收藏的文档总数

1.  **后端查询**:
    在`admin_overview`函数中添加查询语句：
    ```python
    # 文档收藏总数
    collect_cnt = MyCollect.objects.filter(collect_type=1).count() # 1代表文档
    ```
2.  **前端展示**:
    在`admin_overview.html`中添加一个新的统计卡片：
    ```html
    <div class="layui-col-xs6 layui-col-md3">
        <div class="layui-card top-panel">
            <div class="layui-card-header">收藏文档数</div>
            <div class="layui-card-body">
                <div class="layui-row layui-col-space5">
                    <div class="layui-col-xs8 layui-col-md8 top-panel-number" style="color: #28333E;">
                        {{ collect_cnt }}
                    </div>
                    <div class="layui-col-xs4 layui-col-md4 top-panel-tips">
                        <!-- 图标 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    ```
3.  **完成**: 保存文件后，新的“收藏文档数”指标将出现在仪表盘上。

**来源**  
- [views.py](file://app_admin/views.py#L372-L409) - *已更新*
- [admin_overview.html](file://template/app_admin/admin_overview.html#L0-L250) - *已更新*
- [models.py](file://app_doc/models.py#L0-L270)