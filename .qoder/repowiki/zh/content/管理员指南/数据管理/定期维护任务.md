# 定期维护任务

<cite>
**本文档引用文件**  
- [utils.py](file://app_admin/utils.py#L0-L114)
- [models.py](file://app_admin/models.py#L33-L66)
- [views.py](file://app_doc/views.py#L1717-L1791)
- [manage_doc_recycle.html](file://template/app_doc/manage/manage_doc_recycle.html)
- [admin_overview.html](file://template/app_admin/admin_overview.html) - *在最近提交中更新*
</cite>

## 更新摘要
**已做更改**  
- 根据界面重构提交更新了概述部分，反映管理后台的最新状态
- 保留了所有核心维护任务逻辑的准确描述
- 更新了文档来源以包含新修改的模板文件
- 维护了完整的中文语言转换和结构一致性

## 目录
1. [概述](#概述)
2. [系统内置维护任务](#系统内置维护任务)
3. [维护任务实现逻辑](#维护任务实现逻辑)
4. [手动执行维护任务](#手动执行维护任务)
5. [日志记录与错误处理](#日志记录与错误处理)
6. [任务频率设置与监控](#任务频率设置与监控)

## 概述
本系统通过内置的定期维护任务，确保数据的整洁性与安全性。这些任务包括清理过期注册码（RegisterCode）、删除过期电子邮件验证码（EmailVerificationCode）以及回收站文档的清理等。这些任务通常通过定时任务（如Celery或Cron）自动执行，也可通过Django管理界面或API手动触发。根据最近的界面优化提交，管理后台的展示已重构，但核心维护功能保持不变。

## 系统内置维护任务
系统中定义了以下几类核心维护任务：

- **过期注册码清理**：清理已过期或使用次数已满的注册邀请码。
- **过期验证码删除**：清除超过有效期的电子邮件验证码，防止安全漏洞。
- **回收站清理**：支持用户手动清空或还原回收站中的文档。

这些任务旨在减少数据库冗余、提升系统性能并保障用户数据安全。

## 维护任务实现逻辑
### 过期验证码清理
在 `app_admin/models.py` 中定义了 `EmaiVerificationCode` 模型，包含 `expire_time` 字段用于记录验证码的过期时间。

```python
class EmaiVerificationCode(models.Model):
    email_name = models.EmailField(verbose_name="电子邮箱")
    verification_type = models.CharField(verbose_name="验证码类型", max_length=50)
    verification_code = models.CharField(verbose_name="验证码", max_length=10)
    create_time = models.DateTimeField(verbose_name="创建时间", auto_now_add=True)
    expire_time = models.DateTimeField(verbose_name="过期时间")
```

清理逻辑通常由后台定时任务执行，查询 `expire_time < now()` 的记录并批量删除。

### 注册码过期与状态管理
`RegisterCode` 模型中包含 `expire_date` 字段（日期类型）和 `status` 字段用于标识注册码是否有效。

```python
class RegisterCode(models.Model):
    code = models.CharField(verbose_name="注册邀请码", max_length=10, unique=True)
    all_cnt = models.IntegerField(verbose_name="有效注册数量", default=1)
    used_cnt = models.IntegerField(verbose_name='已使用数量', default=0)
    status = models.IntegerField(verbose_name="注册码状态", default=1)
    user_list = models.CharField(verbose_name="使用此注册码的用户", default='', max_length=500, blank=True, null=True)
    expire_date = models.DateField(verbose_name="注册码有效期", null=True, blank=True)
    create_user = models.ForeignKey(User, on_delete=models.CASCADE)
    create_time = models.DateTimeField(auto_now=True, verbose_name='创建时间')
```

在用户注册时，系统会检查注册码是否仍在有效期内（`expire_date >= today`）以及使用次数是否未达上限。相关逻辑位于 `app_admin/views.py` 中。

```python
elif register_code_value.expire_date is not None and register_code_value.expire_date < current_date:
    return JsonResponse({'status': False, 'data': _('注册码已过期')})
```

此逻辑确保了注册码的有效性和安全性。

### 回收站清理机制
回收站功能允许用户将文档标记为“已删除”（状态码为3），但暂不从数据库中移除。管理员或用户可通过界面执行“清空回收站”操作，永久删除这些文档及其关联数据（如历史记录、分享信息、标签等）。

该功能由 `app_doc/views.py` 中的 `doc_recycle` 视图处理：

```python
elif types == 'empty':
    docs = Doc.objects.filter(status=3, create_user=request.user)
    for doc in docs:
        DocHistory.objects.filter(doc=doc).delete()
        DocShare.objects.filter(doc=doc).delete()
        DocTag.objects.filter(doc=doc).delete()
    docs.delete()
    return JsonResponse({'status': True, 'data': _('清空成功')})
```

此逻辑确保了关联数据的一致性，避免产生孤立记录。

**Section sources**
- [models.py](file://app_admin/models.py#L33-L66)
- [views.py](file://app_doc/views.py#L1770-L1791)

## 手动执行维护任务
### 通过Django管理界面触发
系统提供了基于前端模板的管理界面，允许管理员手动执行部分维护任务：

- **清空回收站**：访问“文档管理” -> “回收站”，点击“清空回收站”按钮。
- **还原文档**：选择特定文档或全部文档进行还原操作。

前端通过AJAX请求调用 `/doc_recycle` 接口，传递 `type=empty` 或 `type=restoreAll` 参数来执行对应操作。

```html
<button class="pear-btn pear-btn-danger pear-btn-sm" onclick="emptyDoc()">
    <i class="layui-icon layui-icon-delete" ></i>清空回收站
</button>
```

### 通过API或命令行手动执行
虽然当前代码未直接提供独立的管理命令（如 `manage.py cleanup`），但可通过以下方式扩展：

1. 创建自定义Django命令，封装清理逻辑。
2. 调用现有视图函数中的清理方法（需注意权限控制）。

例如，可编写如下命令清理过期验证码：

```python
from django.core.management.base import BaseCommand
from app_admin.models import EmaiVerificationCode
from datetime import datetime

class Command(BaseCommand):
    def handle(self, *args, **options):
        deleted_count, _ = EmaiVerificationCode.objects.filter(expire_time__lt=datetime.now()).delete()
        self.stdout.write(f'已删除 {deleted_count} 条过期验证码')
```

**Section sources**
- [manage_doc_recycle.html](file://template/app_doc/manage/manage_doc_recycle.html)
- [views.py](file://app_doc/views.py#L1717-L1748)

## 日志记录与错误处理
系统使用 `loguru` 库进行日志记录，在关键操作中捕获异常并输出详细错误信息。

例如，在发送邮件失败时：

```python
except smtplib.SMTPException as e:
    logger.error("邮件发送异常:{}".format(repr(e)))
    return False
```

所有维护任务的执行结果均可在日志中追踪，便于排查问题。建议定期检查日志文件以确认维护任务正常运行。

**Section sources**
- [utils.py](file://app_admin/utils.py#L0-L114)

## 任务频率设置与监控
### 最佳实践
- **清理频率建议**：
  - 验证码清理：每小时执行一次。
  - 注册码状态检查：每日执行一次。
  - 回收站自动清理：可设置为30天后自动清除（当前为手动操作，可扩展）。
- **执行时间建议**：选择系统负载较低的时间段，如凌晨2:00。

### 监控方法
- **日志监控**：定期查看 `loguru` 输出日志，确认任务执行状态。
- **数据库监控**：通过查询 `EmaiVerificationCode` 和 `RegisterCode` 表的数据量变化趋势，判断清理任务是否生效。
- **告警机制**：可集成外部监控工具（如Prometheus + Grafana）对任务执行时间、失败率等指标进行告警。

通过合理配置和持续监控，可确保系统长期稳定运行。

**Section sources**
- [utils.py](file://app_admin/utils.py#L0-L114)
- [models.py](file://app_admin/models.py#L33-L66)