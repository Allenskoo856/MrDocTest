# 环境设置脚本使用指南

<cite>
**本文档引用文件**  
- [setup_env.sh](file://setup_env.sh#L0-L9)
- [README-zh.md](file://README-zh.md#L0-L227)
- [Dockerfile](file://Dockerfile#L0-L60)
- [docker_mrdoc.sh](file://docker_mrdoc.sh#L0-L12)
- [docker-update.sh](file://docker-update.sh#L0-L17)
</cite>

## 目录
1. [简介](#简介)
2. [脚本目的](#脚本目的)
3. [执行步骤](#执行步骤)
4. [命令行参数支持](#命令行参数支持)
5. [不同部署场景下的使用示例](#不同部署场景下的使用示例)
6. [预期输出](#预期输出)
7. [常见错误排查方法](#常见错误排查方法)

## 简介
`setup_env.sh` 是一个 Bash 脚本，用于在本地开发环境中配置 MySQL 8.0 的编译和运行时依赖路径。该脚本主要通过设置环境变量，确保系统能够正确找到 MySQL 客户端库、头文件以及可执行文件，从而支持 Python 项目（如 MrDoc）中与数据库相关的依赖（如 `mysqlclient`）的顺利安装和运行。

该脚本适用于使用 Homebrew 在 macOS 上安装了 `mysql@8.0` 的开发者环境，是项目本地部署前的重要准备步骤之一。

**Section sources**
- [setup_env.sh](file://setup_env.sh#L0-L9)
- [README-zh.md](file://README-zh.md#L0-L227)

## 脚本目的
`setup_env.sh` 的核心目的是为基于 Python 的 Web 应用（如 MrDoc）在本地开发时提供必要的 MySQL 环境支持。具体目标包括：

- **配置 PATH**：将 MySQL 8.0 的二进制可执行文件路径（如 `mysql`, `mysqldump`）添加到系统的 `PATH` 环境变量中，使得这些命令可以在终端任意位置直接调用。
- **配置编译标志**：设置 `CPPFLAGS` 和 `LDFLAGS` 环境变量，分别指定 MySQL 头文件（`.h`）和库文件（`.lib` 或 `.a`）的路径。这对于使用 `pip` 安装需要编译的 Python 包（如 `mysqlclient`）至关重要，确保编译器能够正确链接到 MySQL 的开发库。
- **简化开发环境配置**：通过一键执行脚本，避免开发者手动配置复杂的环境变量，降低环境搭建门槛，提升开发效率。

该脚本不涉及数据库初始化或服务启动，仅负责环境变量的声明。

**Section sources**
- [setup_env.sh](file://setup_env.sh#L0-L9)

## 执行步骤
执行 `setup_env.sh` 脚本的步骤非常简单，遵循以下流程即可：

1. **确保先决条件满足**：
   - 操作系统为 macOS。
   - 已安装 Homebrew 包管理器。
   - 已通过 Homebrew 安装 `mysql@8.0`，命令为：`brew install mysql@8.0`。

2. **导航到项目根目录**：
   打开终端，使用 `cd` 命令进入包含 `setup_env.sh` 的项目目录。
   ```bash
   cd 
   ```

3. **赋予脚本执行权限（首次执行时）**：
   如果脚本尚无执行权限，需先运行以下命令：
   ```bash
   chmod +x setup_env.sh
   ```

4. **执行脚本**：
   通过 `source` 或 `.` 命令执行脚本，以确保环境变量在当前 Shell 会话中生效。
   ```bash
   source setup_env.sh
   ```
   或
   ```bash
   . setup_env.sh
   ```

5. **验证环境变量**：
   执行后，脚本会自动打印当前的 `PATH`、`LDFLAGS` 和 `CPPFLAGS` 值，可手动检查输出是否正确。

**Section sources**
- [setup_env.sh](file://setup_env.sh#L0-L9)

## 命令行参数支持
`setup_env.sh` 脚本目前 **不支持任何命令行参数**。它是一个简单的、无参数的环境配置脚本。

脚本的功能是固定的，即设置针对 `/opt/homebrew/opt/mysql@8.0/` 路径的三个环境变量。如果需要支持不同的 MySQL 版本或安装路径，必须手动修改脚本源码中的路径。

例如，若需适配 Intel 芯片的 Mac，路径可能为 `/usr/local/opt/mysql@8.0/`，则需将脚本中的 `/opt/homebrew` 替换为 `/usr/local`。

**Section sources**
- [setup_env.sh](file://setup_env.sh#L0-L9)

## 不同部署场景下的使用示例

### 场景一：本地开发环境搭建（macOS + Homebrew）
这是 `setup_env.sh` 的标准使用场景。

**步骤**：
1. 安装 MySQL 8.0：
   ```bash
   brew install mysql@8.0
   ```
2. 启动 MySQL 服务：
   ```bash
   brew services start mysql@8.0
   ```
3. 进入项目目录并执行环境设置脚本：
   ```bash
   cd /path/to/MrDocTest
   source setup_env.sh
   ```
4. 安装 Python 依赖（此时 `pip install mysqlclient` 将能成功编译）：
   ```bash
   pip install -r requirements.txt
   ```

### 场景二：Docker 容器化部署
在 Docker 部署中，**不需要也不应该使用 `setup_env.sh`**。

原因：Docker 镜像（如 `Dockerfile`）已经通过 `apk add` 安装了 `mariadb-dev` 等编译依赖，并在构建阶段（builder stage）完成了所有 Python 包的安装。容器运行时环境是自包含的，与宿主机的 Homebrew 环境无关。

**正确做法**：
使用项目提供的 `docker-compose.yml` 和 `docker_mrdoc.sh` 脚本进行一键部署：
```bash
git clone https://gitee.com/zmister/mrdoc-install.git
cd mrdoc-install
./docker-install.sh
```

### 场景三：更新项目代码
当从远程仓库拉取代码更新后，如果更新不涉及环境变量变更，则无需重新执行 `setup_env.sh`。环境变量在 Shell 会话有效期内持续存在。

如果需要更新整个部署，应使用 `docker-update.sh` 脚本（针对 Docker 部署）：
```bash
./docker-update.sh
```
该脚本会拉取最新代码和镜像，并重启容器。

**Section sources**
- [setup_env.sh](file://setup_env.sh#L0-L9)
- [Dockerfile](file://Dockerfile#L0-L60)
- [docker_mrdoc.sh](file://docker_mrdoc.sh#L0-L12)
- [docker-update.sh](file://docker-update.sh#L0-L17)
- [README-zh.md](file://README-zh.md#L0-L227)

## 预期输出
成功执行 `source setup_env.sh` 后，终端将显示以下信息：

```
MySQL 环境变量已设置
PATH: /opt/homebrew/opt/mysql@8.0/bin:[原有PATH内容]
LDFLAGS: -L/opt/homebrew/opt/mysql@8.0/lib
CPPFLAGS: -I/opt/homebrew/opt/mysql@8.0/include
```

**关键点说明**：
- `PATH` 变量的开头会新增 MySQL 的 `bin` 目录路径。
- `LDFLAGS` 和 `CPPFLAGS` 分别正确指向 `lib` 和 `include` 目录。
- 这些变量仅在当前终端会话中有效。关闭终端后，需要重新执行脚本。

**Section sources**
- [setup_env.sh](file://setup_env.sh#L5-L9)

## 常见错误排查方法

### 错误一：`mysql: command not found`
**问题原因**：`PATH` 环境变量未正确设置，或脚本未使用 `source` 执行。
**解决方案**：
1. 确认已执行 `source setup_env.sh`，而非 `./setup_env.sh`（后者会在子 Shell 中执行，变量不会影响父 Shell）。
2. 检查 `/opt/homebrew/opt/mysql@8.0/bin/` 目录是否存在且包含 `mysql` 可执行文件。
3. 手动验证 `PATH`：`echo $PATH | grep mysql`。

### 错误二：`pip install mysqlclient` 编译失败
**问题原因**：`CPPFLAGS` 或 `LDFLAGS` 未正确设置，导致编译器找不到头文件或库。
**解决方案**：
1. 确认已执行 `setup_env.sh` 脚本。
2. 检查 `CPPFLAGS` 和 `LDFLAGS` 的值：
   ```bash
   echo $CPPFLAGS
   echo $LDFLAGS
   ```
   确保输出与脚本中设置的一致。
3. 确认 `mysql.h` 头文件存在：
   ```bash
   ls /opt/homebrew/opt/mysql@8.0/include/mysql/mysql.h
   ```

### 错误三：Homebrew 未安装或 MySQL 未安装
**问题原因**：脚本依赖的路径 `/opt/homebrew/opt/mysql@8.0/` 不存在。
**解决方案**：
1. 安装 Homebrew（Apple Silicon Mac）：
   ```bash
   /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
   ```
2. 安装 MySQL 8.0：
   ```bash
   brew install mysql@8.0
   ```

### 错误四：脚本权限被拒绝
**问题原因**：`setup_env.sh` 文件缺少执行权限。
**解决方案**：
运行以下命令赋予执行权限：
```bash
chmod +x setup_env.sh
```

**Section sources**
- [setup_env.sh](file://setup_env.sh#L0-L9)
- [README-zh.md](file://README-zh.md#L0-L227)