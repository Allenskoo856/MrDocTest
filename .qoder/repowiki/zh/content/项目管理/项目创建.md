# 项目创建

<cite>
**本文档引用的文件**  
- [models.py](file://app_doc/models.py#L1-L270)
- [views.py](file://app_doc/views.py#L260-L299)
</cite>

## 目录
1. [项目模型定义](#项目模型定义)
2. [项目创建视图逻辑](#项目创建视图逻辑)
3. [代码示例](#代码示例)
4. [错误处理机制](#错误处理机制)
5. [常见问题与调试](#常见问题与调试)

## 项目模型定义

`Project` 模型定义了项目（在代码中称为“文集”）的核心属性和约束条件。该模型继承自 Django 的 `models.Model`，并包含以下字段：

- **name**: `CharField`，表示项目名称，最大长度为 50 个字符，是必填字段。
- **icon**: `CharField`，表示项目图标，最大长度为 50 个字符，可为空。
- **intro**: `TextField`，表示项目介绍，是必填字段。
- **role**: `IntegerField`，表示项目权限，是一个整数字段，其值被限制在 `choices=((0,0),(1,1),(2,2),(3,3))` 中。默认值为 0，代表公开。
  - `0`: 公开
  - `1`: 私密
  - `2`: 指定用户可见
  - `3`: 访问码可见
- **role_value**: `TextField`，表示项目权限值，用于存储指定用户列表或访问码，可为空。
- **is_watermark**: `BooleanField`，表示水印状态，布尔值，默认为 `False`。
- **watermark_type**: `IntegerField`，表示水印类型，`1` 为文字水印，`2` 为图片水印，默认为 `1`。
- **watermark_value**: `CharField`，表示水印内容，最大长度为 250 个字符，可为空。
- **is_top**: `BooleanField`，表示是否置顶，布尔值，默认为 `False`。
- **create_user**: `ForeignKey`，外键关联到 Django 的 `User` 模型，表示项目创建者，当用户被删除时，该项目也会被级联删除。
- **create_time**: `DateTimeField`，表示创建时间，`auto_now_add=True` 表示在创建时自动设置为当前时间。
- **modify_time**: `DateTimeField`，表示修改时间，`auto_now=True` 表示在每次保存时自动更新为当前时间。

该模型还定义了 `__str__` 方法，返回项目名称，并通过 `Meta` 类设置了模型的可读名称为“文集”。

**Section sources**
- [models.py](file://app_doc/models.py#L1-L270)

## 项目创建视图逻辑

项目创建功能由 `create_project` 视图函数实现，该函数位于 `app_doc/views.py` 文件中。其实现逻辑如下：

1.  **装饰器**:
    *   `@login_required()`: 确保只有登录用户才能访问此视图。
    *   `@require_http_methods(['POST'])`: 限制此视图仅接受 POST 请求。

2.  **请求处理**:
    *   函数从 POST 请求中获取 `pname` (项目名称)、`picon` (项目图标)、`desc` (描述) 和 `role` (权限) 等参数。
    *   使用 `validateTitle` 函数对项目名称进行过滤，将非法字符（如 `/ \ : * ? " < > |`）替换为下划线 `_`。

3.  **表单验证**:
    *   首先检查项目名称是否为空。如果为空，则返回错误信息“文集名称不能为空！”。
    *   然后检查当前用户下是否存在同名项目。如果存在，则返回错误信息“同名文集已存在！”。这是通过 `Project.objects.filter(name=name, create_user=request.user).exists()` 实现的。

4.  **权限检查**:
    *   由于视图使用了 `@login_required()` 装饰器，因此在执行到创建逻辑时，`request.user` 已经是经过认证的用户。创建操作本身即隐含了权限检查，因为新创建的项目会自动将 `create_user` 字段设置为当前登录用户。

5.  **数据库操作**:
    *   如果所有验证都通过，代码将使用 `Project.objects.create()` 方法创建一个新的 `Project` 对象。
    *   在创建时，会设置 `name`、`icon`、`intro`、`create_user` 和 `role` 等字段。
    *   `role` 字段的值会经过检查，确保它在允许的列表 `role_list = ['0','1','2','3',0,1,2,3]` 中，否则默认为 0（公开）。
    *   创建成功后，调用 `project.save()` 将对象保存到数据库。
    *   最后，返回一个 JSON 响应，包含状态 `True` 和新创建项目的 ID、名称和权限等信息。

6.  **异常处理**:
    *   整个创建逻辑被包裹在 `try...except` 块中。
    *   如果发生任何异常（如数据库错误），`except` 块会捕获异常，记录日志，并返回一个包含错误信息“出现异常,请检查输入值！”的 JSON 响应。

**Section sources**
- [views.py](file://app_doc/views.py#L260-L299)

## 代码示例

以下是一个创建项目请求的处理流程示例：

```python
# 假设这是一个模拟的 POST 请求
def simulate_create_project_request():
    # 模拟的请求数据
    request_data = {
        'pname': '我的新项目',
        'picon': 'icon-book',
        'desc': '这是一个用于测试的项目。',
        'role': '0'
    }
    
    # 模拟的 request 对象
    class MockRequest:
        def __init__(self, data, user):
            self.POST = data
            self.user = user
    
    # 模拟的用户对象
    mock_user = User(id=1, username='testuser')
    
    # 创建模拟请求
    request = MockRequest(request_data, mock_user)
    
    # 调用视图函数
    response = create_project(request)
    
    # 打印响应
    print(response.content.decode('utf-8'))
    # 输出: {"status": true, "data": {"id": 123, "name": "我的新项目", "role": 0}}
```

**Section sources**
- [views.py](file://app_doc/views.py#L260-L299)

## 错误处理机制

项目创建过程中实现了以下错误处理机制：

1.  **名称重复**:
    *   **触发条件**: 用户尝试创建一个与自己已创建的项目同名的项目。
    *   **处理方式**: 在创建前，通过数据库查询 `Project.objects.filter(name=name, create_user=request.user).exists()` 检查同名项目是否存在。
    *   **响应**: 如果存在，则立即返回 `JsonResponse({'status': False, 'data': _('同名文集已存在！')})`，阻止创建操作。

2.  **权限不足**:
    *   **触发条件**: 未登录用户尝试创建项目。
    *   **处理方式**: 由 `@login_required()` 装饰器处理。如果用户未登录，Django 会自动重定向到登录页面，因此 `create_project` 函数本身不会被执行。
    *   **响应**: 用户被重定向到登录页。

3.  **输入验证错误**:
    *   **触发条件**: 项目名称为空。
    *   **处理方式**: 在代码中显式检查 `if name != ''`。
    *   **响应**: 如果为空，则返回 `JsonResponse({'status':False,'data':_('文集名称不能为空！')})`。

4.  **系统异常**:
    *   **触发条件**: 任何未预期的错误，如数据库连接失败、数据类型错误等。
    *   **处理方式**: 通过 `try...except Exception as e:` 捕获所有异常。
    *   **响应**: 记录详细的异常日志，并返回一个通用的错误信息 `JsonResponse({'status':False,'data':_('出现异常,请检查输入值！')})` 给用户，避免暴露敏感的系统信息。

**Section sources**
- [views.py](file://app_doc/views.py#L260-L299)

## 常见问题与调试

1.  **项目创建失败，但没有明确错误提示**:
    *   **可能原因**: 可能是由于 `try...except` 块捕获了异常，但返回的错误信息过于笼统。
    *   **调试建议**: 检查服务器日志（由 `logger.exception(_("创建文集出错"))` 记录）。日志中会包含详细的堆栈跟踪信息，可以帮助定位是数据库问题、数据验证问题还是其他代码逻辑错误。

2.  **字段验证错误**:
    *   **问题**: 用户输入了包含非法字符的项目名称。
    *   **解释**: `validateTitle` 函数会自动将 `/ \ : * ? " < > |` 等字符替换为下划线。因此，用户不会看到验证错误，但最终创建的项目名称会与输入的不同。
    *   **建议**: 可以在前端进行实时验证，提示用户避免使用这些字符，以提供更好的用户体验。

3.  **无法创建项目**:
    *   **可能原因**: 用户未登录。
    *   **调试建议**: 确认用户会话状态。检查浏览器的 Cookie 或使用开发者工具查看网络请求，确认请求是否携带了有效的会话信息。如果未登录，`@login_required` 装饰器会拦截请求。