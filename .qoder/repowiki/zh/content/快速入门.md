# 快速入门

<cite>
**本文档中引用的文件**  
- [README-zh.md](file://docs/README-zh.md) - *已更新数据库配置*
- [requirements.txt](file://requirements.txt) - *已更新mysqlclient版本范围和新增ldap3依赖*
- [docker-compose.yml](file://deploy/docker-compose.yml) - *Docker部署配置文件*
- [docker-compose-with-mysql.yml](file://deploy/docker-compose-with-mysql.yml) - *包含MySQL的完整Docker部署配置*
- [manage.py](file://manage.py)
- [MrDoc/settings.py](file://MrDoc/settings.py)
- [config/config.ini](file://config/config.ini) - *已更新为MySQL配置并新增LDAP配置*
- [docker-update.sh](file://deploy/docker-update.sh) - *系统更新脚本*
- [app_admin/views.py](file://app_admin/views.py) - *新增LDAP登录视图*
- [MrDoc/urls.py](file://MrDoc/urls.py) - *新增LDAP登录路由*
- [app_admin/ldap_backend.py](file://app_admin/ldap_backend.py) - *新增LDAP认证后端*
- [template/ldap_login.html](file://template/ldap_login.html) - *新增LDAP登录模板*
</cite>

## 更新摘要
**已更新内容**
- 在"环境准备"部分添加了LDAP认证相关依赖说明
- 新增"LDAP认证配置"章节，详细介绍LDAP功能的配置和使用
- 更新"关键依赖项说明"表格，添加ldap3依赖项
- 在"常见问题与故障排除"中添加LDAP相关问题解决方案
- 更新文档来源列表，包含所有与LDAP功能相关的新增文件
- **重要变更**：根据最新代码提交，Docker构建文件（Dockerfile）已被移除，部署方式主要依赖官方镜像和docker-compose配置

### 目录
1. [环境准备](#环境准备)
2. [传统部署方式](#传统部署方式)
3. [Docker 部署方式](#docker-部署方式)
4. [系统初始化](#系统初始化)
5. [基本使用](#基本使用)
6. [LDAP认证配置](#ldap认证配置)
7. [关键依赖项说明](#关键依赖项说明)
8. [常见问题与故障排除](#常见问题与故障排除)
9. [性能优化建议](#性能优化建议)

## 环境准备

在开始安装 MrDoc 之前，需要确保系统环境满足基本要求。MrDoc 是一个基于 Python 和 Django 的 Web 应用，因此需要配置相应的运行环境。

### Python 版本要求
MrDoc 要求 Python 版本为 3.9 或更高版本。您可以通过以下命令检查当前 Python 版本：

```bash
python --version
```

如果未安装或版本过低，请前往 [Python 官网](https://www.python.org/) 下载并安装。

### 安装虚拟环境（推荐）
为避免依赖冲突，建议使用 Python 虚拟环境进行部署：

```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境（Linux/macOS）
source venv/bin/activate

# 激活虚拟环境（Windows）
venv\Scripts\activate
```

**Section sources**
- [README-zh.md](file://docs/README-zh.md#L135-L138)

## 传统部署方式

传统部署方式适用于希望手动控制安装过程的用户。

### 1. 安装依赖
在项目根目录下运行以下命令安装所有必需的 Python 包：

```bash
pip install -r requirements.txt
```

该命令将根据 `requirements.txt` 文件安装所有依赖项。

### 2. 数据库配置
根据最新代码变更，MrDoc 的数据库配置已更新为 MySQL。配置文件位于 `config/config.ini`。

**更新后的 MySQL 配置：**
```ini
[database]
engine = mysql
name = mrdoc
user = admin
password = lzl660928
host = 192.168.0.21
port = 3306
```

SQLite 配置（可选）：
```ini
[database]
engine = sqlite
```

**Section sources**
- [config/config.ini](file://config/config.ini#L1-L27) - *已更新为MySQL配置*
- [MrDoc/settings.py](file://MrDoc/settings.py#L140-L182)

### 3. 静态文件收集
在生产环境中，需要收集所有静态文件到指定目录：

```bash
python manage.py collectstatic
```

## Docker 部署方式

Docker 部署是最快捷的安装方式，适合大多数用户。根据最新代码变更，项目已移除 `Dockerfile` 构建文件，现在主要依赖官方镜像和 `docker-compose` 配置进行部署。

### docker-compose.yml 配置
项目根目录下的 `deploy/docker-compose.yml` 文件定义了基础服务配置：

```yaml
version: '3.8'
services:
  mrdoc:
    image: zmister/mrdoc:v9.3  # 使用官方镜像
    volumes:
      - ./config:/app/MrDoc/config
      - ./media:/app/MrDoc/media
      - ./static:/app/MrDoc/static
      - ./log:/app/MrDoc/log
    ports:
      - "10086:10086"
    environment:
      TZ: Asia/Shanghai
    restart: unless-stopped
    dns:
      - 8.8.8.8
      - 114.114.114.114
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:10086/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
```

### 完整部署配置 (docker-compose-with-mysql.yml)
对于生产环境，推荐使用包含数据库和缓存的完整配置：

```yaml
version: '3.8'
services:
  mrdoc:
    image: zmister/mrdoc:v9.3
    container_name: mrdoc-app
    depends_on:
      mysql:
        condition: service_healthy
    # ... 其他配置
  mysql:
    image: mysql:8.0
    container_name: mrdoc-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root_password_123
      MYSQL_DATABASE: mrdoc
      MYSQL_USER: mrdoc_user
      MYSQL_PASSWORD: mrdoc_password
    # ... 其他配置
  redis:
    image: redis:7-alpine
    container_name: mrdoc-redis
    # ... 其他配置
networks:
  mrdoc-network:
    driver: bridge
volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
```

### 部署步骤
1. 克隆部署仓库：
```bash
git clone https://gitee.com/zmister/mrdoc-install.git
cd mrdoc-install
chmod +x docker-install.sh
./docker-install.sh
```

2. 或直接使用现有项目：
```bash
# 使用基础配置
docker-compose -f deploy/docker-compose.yml up -d

# 使用完整配置（推荐）
docker-compose -f deploy/docker-compose-with-mysql.yml up -d
```

### 更新系统
当有新版本发布时，可通过以下脚本更新：

```bash
./deploy/docker-update.sh
```

该脚本会自动拉取最新代码和镜像，并重启服务。

**Section sources**
- [deploy/docker-compose.yml](file://deploy/docker-compose.yml#L1-L43)
- [deploy/docker-compose-with-mysql.yml](file://deploy/docker-compose-with-mysql.yml#L1-L114)
- [deploy/docker-update.sh](file://deploy/docker-update.sh#L1-L18)
- [README-zh.md](file://docs/README-zh.md#L128-L134)

## 系统初始化

完成环境部署后，需要进行系统初始化。

### 1. 数据库迁移
运行以下命令生成并应用数据库迁移：

```bash
# 生成迁移文件
python manage.py makemigrations

# 执行数据库迁移
python manage.py migrate
```

此过程会根据 `app_admin`、`app_doc`、`app_api` 等应用的 `migrations` 目录下的文件创建数据库表结构。

### 2. 创建管理员账户
初始化数据库后，需创建一个管理员账户：

```bash
python manage.py createsuperuser
```

按照提示输入用户名、邮箱和密码。该账户将拥有所有管理权限。

### 3. 重建搜索索引
MrDoc 使用 Whoosh 作为全文搜索引擎，需重建索引：

```bash
python manage.py rebuild_index
```

在 Docker 环境中，此命令通常在启动脚本中自动执行。

**Section sources**
- [manage.py](file://manage.py#L1-L15)
- [README-zh.md](file://docs/README-zh.md#L141-L164)

## 基本使用

### 启动开发服务器
在开发或测试环境中，可使用 Django 自带的服务器：

```bash
python manage.py runserver
```

默认监听 `127.0.0.1:8000`，访问 [http://127.0.0.1:8000](http://127.0.0.1:8000) 即可查看站点。

### 访问管理界面
管理员账户创建完成后，访问 `/admin` 路径登录后台管理：

- URL: `http://your-domain/admin`
- 功能：用户管理、文档管理、站点配置等

### 创建第一个文档
1. 登录系统后，创建一个文集（Project）
2. 在文集中新建文档
3. 使用内置编辑器（支持 Markdown 和富文本）编写内容
4. 保存并发布

系统支持多种编辑器：Editor.md、Vditor、iceEditor，可在个人设置中切换。

**Section sources**
- [README-zh.md](file://docs/README-zh.md#L166-L175)

## LDAP认证配置

MrDoc 现已支持 LDAP 认证功能，允许用户使用企业统一身份认证系统登录。

### 1. 启用LDAP认证
在 `config/config.ini` 文件中配置 LDAP 相关参数：

```ini
[ldap]
# 是否启用LDAP认证，true表示启用，false表示禁用
enable_ldap = true
# LDAP服务器地址
server_uri = ldap://your-ldap-server:389
# 绑定DN，用于连接LDAP服务器进行搜索
bind_dn = cn=admin,dc=example,dc=com
# 绑定密码
bind_password = your-admin-password
# 用户搜索基础DN
user_base_dn = ou=users,dc=example,dc=com
# 用户搜索过滤器，{username}会被替换为实际的用户名
user_search_filter = (uid={username})
# 用户属性映射
user_attr_username = uid
user_attr_email = mail
user_attr_first_name = givenName
user_attr_last_name = sn
```

### 2. LDAP认证流程
1. 用户访问 `/ldap_login` 页面
2. 输入LDAP用户名和密码
3. 系统通过管理员账户连接LDAP服务器搜索用户
4. 验证用户凭据后创建或更新Django用户
5. 成功认证后自动登录

### 3. 使用LDAP登录
1. 访问 `http://your-domain/ldap_login`
2. 输入您的LDAP用户名和密码
3. 登录成功后将自动重定向到首页

系统会自动创建LDAP用户对应的Django账户，首次登录时无需注册。

### 4. 安全特性
- 登录次数限制：连续5次失败后锁定10分钟
- 支持SSL/TLS加密连接
- 用户信息自动同步
- 本地密码不存储，安全性更高

**Section sources**
- [app_admin/ldap_backend.py](file://app_admin/ldap_backend.py#L1-L165) - *LDAP认证后端实现*
- [app_admin/views.py](file://app_admin/views.py#L243-L331) - *LDAP登录视图*
- [MrDoc/urls.py](file://MrDoc/urls.py#L1-L56) - *LDAP路由配置*
- [template/ldap_login.html](file://template/ldap_login.html#L1-L117) - *LDAP登录模板*
- [config/config.ini](file://config/config.ini#L30-L52) - *LDAP配置*

## 关键依赖项说明

`requirements.txt` 文件中列出了所有 Python 依赖项，以下是关键依赖及其作用：

| 依赖包 | 版本 | 作用 |
|--------|------|------|
| django | 4.2.* | Web 框架核心 |
| djangorestframework | 3.15.2 | 提供 RESTful API 支持 |
| django-haystack | 3.3.0 | 全文搜索框架 |
| whoosh | 2.7.4 | 搜索引擎后端 |
| Markdown | 3.7 | Markdown 解析 |
| pillow | >=10.1 | 图像处理 |
| requests | 2.32.3 | HTTP 请求库 |
| mysqlclient | >=2.1.0,<2.2.0 | MySQL 数据库驱动 |
| django-cors-headers | 4.4.0 | 处理跨域请求 |
| ldap3 | >=2.9.1 | LDAP 认证支持 |

这些依赖共同支撑了 MrDoc 的核心功能，如文档渲染、API 接口、搜索功能、数据库连接和LDAP认证。

**Section sources**
- [requirements.txt](file://requirements.txt#L1-L20) - *已更新mysqlclient版本范围和新增ldap3依赖*

## 常见问题与故障排除

### 1. Django 无法导入
错误信息：`Couldn't import Django`
- 解决方案：确保已激活虚拟环境并正确安装 Django

### 2. 数据库连接失败
- 检查 `config.ini` 中的数据库配置
- 确认数据库服务正在运行
- 对于 MySQL，确保已创建相应数据库

### 3. 静态文件无法加载
- 运行 `python manage.py collectstatic`
- 检查 `settings.py` 中的 `STATIC_ROOT` 配置

### 4. Docker 容器无法启动
- 检查端口是否被占用
- 确认 `docker-compose.yml` 文件格式正确
- 查看容器日志：`docker logs <container_name>`

### 5. 搜索功能异常
- 重建搜索索引：`python manage.py rebuild_index`
- 检查 `whoosh_index` 目录权限

### 6. LDAP认证问题
- **LDAP认证未启用**：检查 `config.ini` 中 `enable_ldap` 是否设置为 `true`
- **连接LDAP服务器失败**：验证 `server_uri` 配置是否正确，确保网络可达
- **用户搜索失败**：检查 `user_base_dn` 和 `user_search_filter` 配置
- **认证凭据错误**：确认 `bind_dn` 和 `bind_password` 正确
- **用户属性映射错误**：根据实际LDAP服务器配置调整 `user_attr_*` 参数

**Section sources**
- [README-zh.md](file://docs/README-zh.md#L177-L184)
- [MrDoc/settings.py](file://MrDoc/settings.py#L220-L230)
- [app_admin/ldap_backend.py](file://app_admin/ldap_backend.py#L1-L165)

## 性能优化建议

### 1. 生产环境配置
- 将 `DEBUG = False`
- 使用 Nginx + uWSGI 部署
- 配置反向代理和静态文件缓存

### 2. 数据库优化
- 对于高并发场景，建议使用 MySQL 或 PostgreSQL 替代 SQLite
- 添加适当索引，特别是在 `app_doc.Doc` 和 `app_doc.Project` 模型上

### 3. 缓存配置
修改 `config.ini` 启用 Redis 或 Memcached：

```ini
[cache]
backend = redis
location = redis://127.0.0.1:6379/1
```

### 4. 搜索性能
- 定期维护 Whoosh 索引
- 考虑在数据量大时迁移到 Elasticsearch

### 5. 定期备份
使用内置的备份功能或自定义脚本定期备份数据库和媒体文件。

**Section sources**
- [MrDoc/settings.py](file://MrDoc/settings.py#L165-L182)
- [README-zh.md](file://docs/README-zh.md#L186-L192)